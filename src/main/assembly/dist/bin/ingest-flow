#!/usr/bin/env python3

import argparse
import os

import requests

service_baseurl = 'http://localhost:20300'


def start_import(path, continue_previous, migration):
    status = os.system("chmod -R g+w %s" % path)
    if status != 0:
        print("Could not make import batch available to group")
        exit(1)
    r = requests.post('%s/imports/:start' % service_baseurl, json={
        'batch': os.path.abspath(path),
        'continue': continue_previous,
        'migration': migration
    })
    print('Server responded: %s' % r.text)

def list_events(params):
    r = requests.get('%s/events' % service_baseurl, headers={'Accept': 'text/csv'}, params=params)
    print(r.text)

parser = argparse.ArgumentParser(add_help=True)
subparsers = parser.add_subparsers(dest='command')
parser_import = subparsers.add_parser('start-import',
                                      help='start import of a batch of deposits')

parser_import.add_argument('batch',
                           metavar='<batch-directory>',
                           help='path to batch of deposits to import; the directory must be located inside the import area')
parser_import.add_argument('-c', '--continue',
                           action='store_true',
                           dest='continue_previous',
                           help='continue previously stopped batch (i.e. allow output directory to be non-empty)')
parser_import.add_argument('-m', '--migration',
                           action='store_true',
                           dest='migration',
                           default=True,
                           help='import as migrated datasets (default = True)')

parser_events = subparsers.add_parser('list-events',
                                      help='print events per deposit')
parser_events.add_argument('-s', '--source',
                           dest='source',
                           metavar='<source>',
                           help='only events for this source (i.e. batch or auto-ingest)')
parser_events.add_argument('-d', '--deposit',
                           metavar='<uuid>',
                           dest='deposit_id',
                           help='only events for this deposit')

parser_status = subparsers.add_parser('get-status',
                                      help='print last event per deposit')
parser_status.add_argument('-b', '--batch',
                           dest='batch',
                           metavar='<batch>',
                           help='only status of this batch')
parser_status.add_argument('-d', '--deposit',
                           metavar='<uuid>',
                           dest='deposit_id',
                           help='only status of this deposit')

args = parser.parse_args()

if args.command == 'start-import':
    start_import(args.batch, args.continue_previous, args.migration)
elif args.command == 'list-events':
    params = {}
    if args.source is not None:
        params['source'] = args.source
    if args.deposit_id is not None:
        params['depositId'] = args.deposit_id
    list_events(params)